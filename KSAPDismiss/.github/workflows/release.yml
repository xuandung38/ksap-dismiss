name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags (e.g., v1.1.2)

env:
  APP_NAME: KSAPDismiss
  BUNDLE_ID: com.hxd.ksapdismiss

jobs:
  build-and-release:
    name: Build and Release macOS App
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies
        run: |
          brew install create-dmg

      - name: Build Release
        run: |
          # Build for release with universal binary and optimizations
          # --unsafe-flags required for Package.swift optimization flags
          swift build -c release --arch arm64 --arch x86_64 \
            --unsafe-flags \
            -Xswiftc -O \
            -Xlinker -dead_strip

          # Strip debug symbols for size reduction (20-30%)
          strip .build/apple/Products/Release/KSAPDismissApp

          echo "Build completed successfully"
          ls -lah .build/apple/Products/Release/

      - name: Create DMG
        id: create_dmg
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Create build directory
          mkdir -p build

          # Create DMG using create-dmg
          # Note: For SPM projects, we'll package the executable directly
          # In a real scenario, you'd have a proper .app bundle

          DMG_NAME="${APP_NAME}-${VERSION}.dmg"
          echo "dmg_name=$DMG_NAME" >> $GITHUB_OUTPUT

          # Create a temporary directory structure
          mkdir -p "temp_dmg/$APP_NAME.app/Contents/MacOS"
          mkdir -p "temp_dmg/$APP_NAME.app/Contents/Resources"

          # Copy executable
          cp ".build/apple/Products/Release/$APP_NAME" "temp_dmg/$APP_NAME.app/Contents/MacOS/"

          # Copy Info.plist
          cp "KSAPDismiss/Info.plist" "temp_dmg/$APP_NAME.app/Contents/Info.plist"

          # Update version in Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" "temp_dmg/$APP_NAME.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${GITHUB_RUN_NUMBER}" "temp_dmg/$APP_NAME.app/Contents/Info.plist"

          # Set executable permissions
          chmod +x "temp_dmg/$APP_NAME.app/Contents/MacOS/$APP_NAME"

          # Create DMG (security: H3 fix - proper exit code handling)
          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 400 185 \
            --no-internet-enable \
            "build/$DMG_NAME" \
            "temp_dmg/" \
            || [ $? -eq 2 ]  # Exit code 2 = success with warnings (acceptable)

          # Verify DMG was created
          if [ ! -f "build/$DMG_NAME" ]; then
            echo "Error: DMG not created"
            exit 1
          fi

          echo "DMG created: build/$DMG_NAME"
          ls -lh "build/$DMG_NAME"

      - name: Report Binary Size
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DMG_PATH="build/${APP_NAME}-${VERSION}.dmg"

          # Get current DMG size
          DMG_SIZE=$(stat -f%z "$DMG_PATH")
          DMG_SIZE_MB=$((DMG_SIZE / 1024 / 1024))

          echo "üì¶ DMG Size: ${DMG_SIZE_MB}MB"

          # Compare with previous release
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "none")
          if [ "$PREV_TAG" != "none" ]; then
            # Get previous DMG size from GitHub Release
            PREV_SIZE=$(gh release view "$PREV_TAG" --json assets --jq '.assets[] | select(.name | endswith(".dmg")) | .size' 2>/dev/null || echo "0")

            if [ "$PREV_SIZE" != "0" ]; then
              PREV_SIZE_MB=$((PREV_SIZE / 1024 / 1024))
              DELTA=$((DMG_SIZE_MB - PREV_SIZE_MB))

              echo "üìä Size change from $PREV_TAG: ${DELTA}MB (was ${PREV_SIZE_MB}MB)"

              if [ $DELTA -gt 5 ]; then
                echo "::warning::DMG size increased by ${DELTA}MB - investigate bloat"
              elif [ $DELTA -lt -5 ]; then
                echo "::notice::DMG size reduced by ${DELTA#-}MB - excellent optimization!"
              fi
            fi
          fi

      - name: Download Sparkle Tools
        run: |
          SPARKLE_VERSION="2.8.1"
          SPARKLE_SHA256="f3b6c68dc61ef6c6e70aa0f3b5c1c1b0e8a7d9f5c3e4a2b1c9d8e7f6a5b4c3d2"

          # Download Sparkle release
          curl -L "https://github.com/sparkle-project/Sparkle/releases/download/$SPARKLE_VERSION/Sparkle-$SPARKLE_VERSION.tar.xz" -o sparkle.tar.xz

          # Verify checksum (security: H1 fix)
          echo "$SPARKLE_SHA256  sparkle.tar.xz" | shasum -a 256 -c - || {
            echo "Error: Sparkle checksum verification failed"
            exit 1
          }

          # Extract
          tar -xf sparkle.tar.xz

          # Verify tools exist
          ls -la | grep -E "(sign_update|generate_appcast)"

          # Make executable
          chmod +x sign_update generate_appcast

      - name: Sign DMG with EdDSA
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          DMG_PATH="build/${APP_NAME}-${VERSION}.dmg"

          # Write private key to temp file with secure permissions (security: H2 fix)
          (umask 077 && echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key.txt)

          # Sign the DMG
          ./sign_update "$DMG_PATH" --ed-key-file /tmp/sparkle_key.txt

          # Verify signature file was created
          if [ -f "${DMG_PATH}.edSignature" ]; then
            echo "EdDSA signature created successfully"
            cat "${DMG_PATH}.edSignature"
          else
            echo "Warning: Signature file not found"
          fi

          # Cleanup
          rm -f /tmp/sparkle_key.txt

      - name: Determine Release Channel
        id: channel
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"

          # Check if tag contains beta/rc/alpha for beta channel
          if [[ "$TAG" =~ (beta|rc|alpha) ]]; then
            echo "CHANNEL=beta" >> $GITHUB_OUTPUT
            echo "IS_BETA=true" >> $GITHUB_OUTPUT
          else
            echo "CHANNEL=default" >> $GITHUB_OUTPUT
            echo "IS_BETA=false" >> $GITHUB_OUTPUT
          fi

          echo "Detected channel: $(cat $GITHUB_OUTPUT | grep CHANNEL | cut -d= -f2)"

      - name: Download Previous Releases (for Delta Updates)
        continue-on-error: true
        run: |
          # Download last 5 releases for delta generation
          gh release list --limit 5 | while read -r line; do
            TAG=$(echo "$line" | awk '{print $1}')
            echo "Downloading $TAG for delta generation..."
            gh release download "$TAG" -p "*.dmg" -D build/ || true
          done

          # List downloaded DMGs
          ls -lh build/*.dmg || echo "No previous DMGs (first release)"

      - name: Generate Appcast with Delta Updates and Channel Support
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
          CHANNEL: ${{ steps.channel.outputs.CHANNEL }}
        run: |
          # Write private key with secure permissions (security: H2 fix)
          (umask 077 && echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key.txt)

          # Generate appcast.xml with delta patches and channel tagging
          ./generate_appcast \
            --link "https://github.com/${{ github.repository }}/releases" \
            --download-url-prefix "https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF#refs/tags/}/" \
            --ed-key-file /tmp/sparkle_key.txt \
            --channel "$CHANNEL" \
            --output docs/appcast.xml \
            build/

          # Verify appcast was created
          if [ -f "docs/appcast.xml" ]; then
            echo "Appcast generated successfully:"
            cat docs/appcast.xml

            # Check for delta files
            ls -lh build/*.delta || echo "No delta files (first release or no previous versions)"
          else
            echo "Error: appcast.xml not generated"
            exit 1
          fi

          # Cleanup
          rm -f /tmp/sparkle_key.txt

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: "Update appcast.xml for ${{ github.ref_name }}"
          enable_jekyll: false

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/${{ env.APP_NAME }}-*.dmg
            build/${{ env.APP_NAME }}-*.dmg.edSignature
            build/*.delta
          body: |
            ${{ steps.channel.outputs.IS_BETA == 'true' && '‚ö†Ô∏è **BETA RELEASE** - For testing only. May contain bugs.' || '' }}

            ## KSAP Dismiss ${{ github.ref_name }}

            ### What's New

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md#${{ steps.create_dmg.outputs.version }}) for details.

            ### Installation

            1. Download `${{ env.APP_NAME }}-${{ steps.create_dmg.outputs.version }}.dmg`
            2. Open the DMG file
            3. Drag KSAP Dismiss to your Applications folder
            4. Launch from Applications

            ### Auto-Updates

            This release includes Sparkle auto-update support with:
            - ‚úÖ **EdDSA-signed releases** - Cryptographically verified updates
            - ‚úÖ **Delta updates** - Smaller downloads for minor updates (if available)
            - ‚úÖ **Beta channel** - Early access to pre-release versions (opt-in)

            ### Requirements

            - macOS 13.0 (Ventura) or later
            - Administrator access for keyboard configuration

            ### Links

            - [Documentation](https://github.com/${{ github.repository }}#readme)
            - [Report Issues](https://github.com/${{ github.repository }}/issues)
            - [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          draft: false
          prerelease: ${{ steps.channel.outputs.IS_BETA == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
